# relative working directory
function wd {
    echo ${$(pwd)/$HOME\//}
}

# quick history searches
function h {
    history -df -100000 | grep $1
}

# process management
function pg {
    ps -Af | grep $1 | grep -v grep
}

# head helper functions
function hl {
    head -n10 $1 | less
}
function hv {
    head -n10 $1 | vd -
}

#
# taskwarrior
#

# show tasks for a specific project
function tp {
    project=`task projects | head -n-2 | tail -n+5 | awk '{print $1}' | fzf -1 --exact`
    task project:$project
}

#
# fzf notes
# 

# edit note
function n {
    wd=`pwd`

    cd ~/d/notes
    target=`fd -t f md | grep --color='none' "$1" | fzf -1 --exact`

    if [ ! -z "$target" ]; then
        vim $target
    fi

    cd $wd
}

# add note
function a {
    pwd=`pwd`

    cd ~/d/notes

    # get directory to store note in
    target=`fd -t d | grep --color='none' "$1" | fzf -1 --exact`

    # prompt user for filename
    if [ ! -z "$target" ]; then
        vared -p "Filename? (${target}/XX): " -c fname
        vim $target/$fname
    fi

    cd $pwd
}

# project todo lists
alias td="bash ~/d/r/cookiecutter/proj/scripts/todo.sh ~/d/notes/proj"

function tda {
    pwd=`pwd`

    cd ~/d/notes/proj
    target=`fd -t f todo.md | grep --color='none' "$1" | fzf -1 --exact`

    if [ ! -z "$target" ]; then
        vim $target
    fi

    cd $pwd
}

# fzf confs
function c {
    target=`fd --regex 'conf|init|rc|aliases|exports|functions|private|Renviron|Rprofile|rofi-tasks|scratch.vim|zshenv' \
            --exclude Extracted ~/.dotfiles |\
            grep --color='none' "$1" |\
            fzf -1 --exact`

    if [ ! -z "$target" ]; then
        vim $target
    fi
}

# vim + ag
function va {
    nvim $(ag -l $1)
}

# zcat | wc -l
function zcl {
    zcat $1 | wc -l
}

# number of columns
function nc {
    if [[ $1 == *.tsv* ]]; then
        csvgrep -n -t $1 | wc -l
    else
        csvgrep -n $1 | wc -l
    fi
}

# feh browse dir
function fehd {
    feh â€“start-at $1
}

# syntax highlighting in less 
function les {
    src-hilite-lesspipe.sh "$1" | less -R
}

#
# ffmpeg h.265 video conversion
# 
# <input> <start> <duration>
# 
function ffh265 {
    local infile=$1
    local ext="${infile##*.}"
    local outfile=${infile/$ext/mp4}

    # convert entire video
    if [ $# -eq 1 ]; then
        cmd="ffmpeg -i $infile -c:v libx265 -crf 28 -preset medium -c:a aac -b:a 192k $outfile"
        echo $cmd
    else
        local start=$2
        local duration=$3

        # otherwise, if start and duration specified, convert a specific region;
        # note that when the "-ss" option is used, timestamp gets reset, and so 
        # a duration (-t) must be used in place of the "-to" switch
        cmd="ffmpeg -ss \"$start\" -i $infile -t \"$duration\" -c:v libx265 -crf 28 -preset medium -c:a aac -b:a 192k $outfile"
        echo $cmd
    fi
}

#
# checks for some specified gene identifier in several different reference annotations
# and mapping
#
function check_gene {
    query=$1

    # Strip "LOC" prefix, if present;
    # "LOC" genes are listed in NCBI genes without the "LOC" prefix
    # https://www.ncbi.nlm.nih.gov/books/NBK3840/
    if [ "$1" != "${query#LOC}" ]; then
        echo "Removing LOC prefix..."
        query=${query#LOC} 
    fi

    echo "Checking Ensembl GRCh37 GTF..."
    zgrep $query /data/ref/human/ensembl/GRCh37/100/Homo_sapiens.GRCh37.87.gtf.gz

    echo "Checking Ensembl GRCh38 GTF..."
    zgrep $query /data/ref/human/ensembl/GRCh38/100/Homo_sapiens.GRCh38.100.gtf.gz

    echo "Checking HUGO gene symbol mapping..."
    grep $query /data/ref/human/hugo/genenames_2020-08-08.tsv

    echo "Checking NCBI Genes..." 
    zgrep $query /data/ref/human/ncbi/Homo_sapiens.gene_info.gz
}
 
